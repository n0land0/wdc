steps:
  TMP_LINE_ITEM_HISTORY-5577:
    operation:
      config:
        insertStrategy: INSERT
        postSQL: ""
        preSQL: ""
        testsEnabled: true
        truncateBefore: true
      database: ""
      dependencies: []
      deployEnabled: true
      description: Recurly has a PK combination that includes the updated_at column. Due to this PK combination, every time a record is updated coalesce will see it as a branch new record and not a modified record. In order to have the records persisted correctly, a row_number() function is used to group records by uuid and then choose the most up-to-date record to pass to the persisted layer.
      isDataVault: false
      isMultisource: false
      locationID: ""
      locationName: TRANSFORM_DIMENSION
      materializationType: table
      metadata:
        appliedNodeTests: []
        columns:
          - columnReference:
              columnCounter: "371151"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: ID
            nullable: false
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33267"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371152"
              stepCounter: "5577"
            dataType: TIMESTAMP_TZ(9)
            description: ""
            hashDetails: null
            name: UPDATED_AT
            nullable: false
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33268"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371153"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: ACCOUNT_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33269"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371154"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: PLAN_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33270"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371155"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: ADD_ON_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33271"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371156"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: INVOICE_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33272"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371157"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: PREVIOUS_LINE_ITEM_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33273"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371158"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: ORIGINAL_LINE_ITEM_INVOICE_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33274"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371159"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: SUBSCRIPTION_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33275"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371160"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: UUID
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33276"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371161"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: TYPE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33277"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371162"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: STATE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33278"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371163"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: LEGACY_CATEGORY
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33279"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371164"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: PLAN_CODE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33280"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371165"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: ADD_ON_CODE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33281"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371166"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: INVOICE_NUMBER
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33282"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371167"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: ORIGIN
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33283"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371168"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: ACCOUNTING_CODE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33284"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371169"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: PRODUCT_CODE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33285"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371170"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: CREDIT_REASON_CODE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33286"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371171"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: CURRENCY
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33287"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371172"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: AMOUNT
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33288"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371173"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: DESCRIPTION
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33289"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371174"
              stepCounter: "5577"
            dataType: NUMBER(38,0)
            description: ""
            hashDetails: null
            name: QUANTITY
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33290"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371175"
              stepCounter: "5577"
            dataType: FLOAT
            description: ""
            hashDetails: null
            name: UNIT_AMOUNT
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33291"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371176"
              stepCounter: "5577"
            dataType: FLOAT
            description: ""
            hashDetails: null
            name: SUBTOTAL
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33292"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371177"
              stepCounter: "5577"
            dataType: FLOAT
            description: ""
            hashDetails: null
            name: DISCOUNT
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33293"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371178"
              stepCounter: "5577"
            dataType: FLOAT
            description: ""
            hashDetails: null
            name: TAX
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33294"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371179"
              stepCounter: "5577"
            dataType: BOOLEAN
            description: ""
            hashDetails: null
            name: TAXABLE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33295"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371180"
              stepCounter: "5577"
            dataType: BOOLEAN
            description: ""
            hashDetails: null
            name: TAX_EXEMPT
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33296"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371181"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: TAX_CODE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33297"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371182"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: TAX_TYPE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33298"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371183"
              stepCounter: "5577"
            dataType: VARCHAR(256)
            description: ""
            hashDetails: null
            name: TAX_REGION
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33299"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371184"
              stepCounter: "5577"
            dataType: FLOAT
            description: ""
            hashDetails: null
            name: TAX_RATE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33300"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371185"
              stepCounter: "5577"
            dataType: FLOAT
            description: ""
            hashDetails: null
            name: PRORATION_RATE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33301"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371186"
              stepCounter: "5577"
            dataType: BOOLEAN
            description: ""
            hashDetails: null
            name: REFUND
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33302"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371187"
              stepCounter: "5577"
            dataType: NUMBER(38,0)
            description: ""
            hashDetails: null
            name: REFUNDED_QUANTITY
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33303"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371188"
              stepCounter: "5577"
            dataType: FLOAT
            description: ""
            hashDetails: null
            name: CREDIT_APPLIED
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33304"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371189"
              stepCounter: "5577"
            dataType: TIMESTAMP_TZ(9)
            description: ""
            hashDetails: null
            name: START_DATE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33305"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371190"
              stepCounter: "5577"
            dataType: TIMESTAMP_TZ(9)
            description: ""
            hashDetails: null
            name: END_DATE
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33306"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371191"
              stepCounter: "5577"
            dataType: TIMESTAMP_TZ(9)
            description: ""
            hashDetails: null
            name: CREATED_AT
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33307"
                    stepCounter: "1487"
                transform: ""
          - columnReference:
              columnCounter: "371192"
              stepCounter: "5577"
            dataType: TIMESTAMP_TZ(9)
            description: ""
            hashDetails: null
            name: _FIVETRAN_SYNCED
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "33308"
                    stepCounter: "1487"
                transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: "371193"
              stepCounter: "5577"
            config: {}
            dataType: NUMBER(38,0)
            defaultValue: ""
            description: ""
            keyColumnType: None
            name: LINE_ITEM_ROW_NUMBER
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "0"
                    stepCounter: "0"
                transform: ROW_NUMBER() OVER (PARTITION BY "LINE_ITEM_HISTORY"."UUID" ORDER BY "LINE_ITEM_HISTORY"."UPDATED_AT" DESC)
            systemColumnType: None
            transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: "371521"
              stepCounter: "5577"
            config: {}
            dataType: VARCHAR(5)
            defaultValue: ""
            description: ""
            keyColumnType: None
            name: ACTIVE_FLAG
            nullable: true
            sourceColumnReferences:
              - columnReferences:
                  - columnCounter: "0"
                    stepCounter: "0"
                transform: CASE WHEN "LINE_ITEM_ROW_NUMBER" =1 THEN 'Y' WHEN "LINE_ITEM_ROW_NUMBER" <> 1 THEN 'N' ELSE 'ERROR' END
            systemColumnType: None
            transform: ""
        cteString: ""
        enabledColumnTestIDs: []
        sourceMapping:
          - aliases:
              LINE_ITEM_HISTORY: "1487"
            customSQL:
              customSQL: ""
            dependencies:
              - locationName: SOURCES_RECURLY
                nodeName: LINE_ITEM_HISTORY
            join:
              joinCondition: |-
                FROM {{ ref('SOURCES_RECURLY', 'LINE_ITEM_HISTORY') }} "LINE_ITEM_HISTORY"
                QUALIFY "ACTIVE_FLAG" = 'Y'
            name: TMP_LINE_ITEM_HISTORY
            noLinkRefs: []
      name: TMP_LINE_ITEM_HISTORY
      overrideSQL: false
      schema: ""
      sqlType: Stage
      type: sql
    stepCounter: "5577"
